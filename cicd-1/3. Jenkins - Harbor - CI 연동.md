# 3. Jenkins - Harbor - CI 연동
-   본 문서는 아래 절차에 대해서 설명 합니다.
	- Jenkins Pipeline를 통하여 Gitlab에서 Source Code Clone & Build
	- Build Image 생성
	- Build Image Harbor Upload
	
-   실행 환경
    -   AWS EKS 구성
    -   Nginx Ingress 구성
    -   Jenkins v2.303.2 (Helm)
    -   Harbor v2.2.4 (VM)

- Jenkins 주요 Plugin 구성
	- Kubernetes
	- Git
	- Pipeline
	- Generic Webhook Trigger

- 각 Node에서 Harbor 접근 확인 아래와 같은 형태의 에러가 발생한다면 docker insecure 또는 harbor 설치 시 사용하였던 인증서를 각 Node VM에 신뢰하는 인증서로 추가
- EKS의 경우 VM에 ssh 하여 편집하고 AMI로 해당 이미지를 저장하여 Launch templates과 Auto Scaling groups를 수정해야 한다. 본 가이드에서는 harbor는 VM으로 빠져있기 때문에 /etc/hosts와 ca.crt를 EKS Worker Node VM에 등록 시킴

```
Error response from daemon: Get "https://xxx.xxx.leedh.cloud/v2/": x509: certificate is valid for  xxx.xxx.leedh.cloud
```

1) Insecure 추가 방안 

```
# /etc/docker/daemon.json 아래 실행 명령 추가
{
"insecure-registries":["xxx.xxx.leedh.cloud"]
}

$ docekr restart
```

2) CA 추가 방안 (Harbor 설치 시 생성 된 CA 파일을 VM의 신뢰하는 기관으로 추가)

```
# ubuntu 기준 /usr/local/share/ca-certificates 파일에 harbor ca 파일 생성
-rw-r--r-- 1 root root 2037 Nov  1 06:27 ca.crt
-rw-r--r-- 1 root root 2074 Oct 28 06:02 xxx.xxx.xxx.crt

$ sudo update-ca-certificates
```

## 1. Jenkins - Harbor - CI 연동 설정

### 1.1. Jenkins 용 Private Registry Harbor 인증 설정 (Docker가 로그인 되어 있는 상태)
- Kubenetes에서 배포 할 Private Registry Harbor의 Image를 Pull 할 수 있도록 인증 정보를 생성

```
$ kubectl -n jenkins create secret generic docker-registry \
--from-file=.dockerconfigjson=/home/leedh/.docker/config.json \
--type=kubernetes.io/dockerconfigjson
```

### 1.2. Jenkins Credential 생성
- Jenkins UI에서 [Jenkins 관리] -> [Managed Credentials] 버튼을 클릭

- Jenkins와 Source Code 저장 소 간 연동을 위한 Credentials을 생성

![jenkins-pipeline-1][jenkins-pipeline-1]

[jenkins-pipeline-1]:./images/jenkins-pipeline-1.PNG

- Jenkins와 Harbor 연동을 위한 Credentials을 생성

![jenkins-pipeline-2][jenkins-pipeline-2]

[jenkins-pipeline-2]:./images/jenkins-pipeline-2.PNG




